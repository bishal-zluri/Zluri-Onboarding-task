LOCAL FILESYSTEM (sync-day1)
├─ agents
├─ agent_details
└─ roles
      │
      ▼
read_local_data()
  ├─ resolve project root dynamically
  ├─ scan JSON / CSV / Parquet
  ├─ union multiple formats
  ├─ add source_path
  └─ return unified DataFrame
      │
      ▼
process_agents_data()
  │
  ├─ read agents (REQUIRED)
  ├─ read agent_details (OPTIONAL)
  │     └─ fallback to agents if missing
  ├─ read roles (OPTIONAL)
  │
  ├─ JOIN agents + agent_details (LEFT)
  │     └─ dummy empty details table if missing
  │
  ├─ FALLBACK LOGIC (Agent Details → Agent Index)
  │     ├─ user_name
  │     │     ├─ det.contact.name
  │     │     ├─ idx.name
  │     │     └─ idx.first_name + idx.last_name
  │     │
  │     ├─ user_email
  │     │     ├─ det.contact.email
  │     │     └─ idx.email
  │     │
  │     ├─ created_at / updated_at
  │     │     ├─ det timestamps
  │     │     └─ idx timestamps
  │
  ├─ explode_outer(role_ids)
  │     └─ preserves users with NO roles
  │
  ├─ JOIN roles (LEFT)
  │     └─ role_name, role_desc
  │
  └─ OUTPUT
        → one row per (user_id, role_id)
        → NULL role rows allowed
      │
      ▼
transform_and_reconcile_users()
  │
  ├─ STEP 1: Validation & Cleaning
  │     │
  │     ├─ cast user_id → Long
  │     │     └─ drop non-numeric IDs
  │     ├─ drop missing / empty user_name
  │     ├─ drop missing / empty user_email
  │     ├─ try_cast created_at, updated_at
  │     │     └─ malformed dates → NULL (no crash)
  │     │
  │     └─ OUTPUT
  │           → df_clean (trusted records only)
  │
  ├─ cache cleaned exploded data
  │
  ├─ DERIVE ROLES TABLE
  │     ├─ distinct(role_id, role_name, role_desc)
  │     ├─ exclude NULL role_id
  │     └─ exclude numeric-only role_name
  │
  ├─ DERIVE USER_ROLES TABLE
  │     ├─ distinct(user_id, role_id, role_name)
  │     ├─ exclude NULL user_id / role_id
  │     └─ exclude numeric-only role_name
  │
  ├─ AGGREGATE USERS
  │     └─ groupBy(user_id, user_name, user_email, created_at, updated_at)
  │
  ├─ READ existing users from Postgres
  │
  ├─ RECONCILIATION (FULL OUTER JOIN)
  │     │
  │     ├─ new.user_id present  → ACTIVE
  │     ├─ missing in new batch → INACTIVE
  │     ├─ coalesce(new, old) for name/email
  │     ├─ preserve created_at from DB if missing
  │     └─ preserve updated_at from DB if missing
  │
  ├─ FINAL SAFETY FILTER
  │     └─ user_id IS NOT NULL
  │
  └─ OUTPUT DATAFRAMES
        ├─ df_final_users
        ├─ df_roles
        └─ df_user_roles
      │
      ▼
load_user_pipeline()
  │
  ├─ init_db()
  │     ├─ users        (PK: user_id)
  │     ├─ roles        (PK: role_id)
  │     └─ user_roles   (PK: user_id + role_id)
  │
  ├─ LOAD ROLES (UPSERT)
  │     ├─ write roles_stage
  │     ├─ INSERT … ON CONFLICT(role_id)
  │     └─ DROP roles_stage
  │
  ├─ LOAD USERS (UPSERT)
  │     ├─ write users_stage
  │     ├─ INSERT … ON CONFLICT(user_id)
  │     └─ DROP users_stage
  │
  ├─ LOAD USER_ROLES (SYNC)
  │     ├─ write user_roles_stage
  │     ├─ DELETE existing user mappings
  │     ├─ INSERT new mappings
  │     └─ DROP user_roles_stage
  │
  └─ PIPELINE COMPLETE
